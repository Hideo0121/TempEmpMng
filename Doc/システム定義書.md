# 短期派遣受入管理システム システム定義書（ドラフト）

- 作成日: 2025-09-29
- 作成者: TempEmpMng プロジェクトチーム
- 適用対象: 短期派遣受入管理システム（社内利用）
- 関連資料: `短期派遣受入管理システム_要件定義.md`、`詳細設計メモ.md`、`通知設計メモ.md`

---

## 1. システム概要

### 1.1 目的
社内で行っている短期派遣スタッフ受け入れ業務において、派遣会社からの紹介受領から職場見学の調整・決定、ステータス管理、リマインド通知までを一元管理する。紙／メール運用で発生していた情報散逸とリマインド漏れを解消し、受入担当と管理者の業務を可視化することを目的とする。

### 1.2 システム種別
- 社内専用の Web アプリケーション。
- 派遣元企業には公開しない。
- 社内 Active Directory などとは直接連携せず、アプリ内アカウントで運用する。

### 1.3 稼働環境
| 区分 | 内容 |
|---|---|
| OS / Web サーバ | Windows Server + IIS 10 (FastCGI/PHP) |
| アプリケーション | Laravel 11, PHP 8.3 |
| フロントエンド | Blade + Tailwind CSS + Vite |
| データベース | MySQL 8.x （Access から ODBC 参照予定、`INT` ベース） |
| キュー / バッチ | Laravel Queue (Redis) + Scheduler |
| リポジトリ | GitHub Private Repo（想定） |

---

## 2. 運用スコープ

### 2.1 対象業務
- 派遣会社からの候補者紹介受付
- 候補者情報登録 / 編集
- 職場見学候補日の管理および確定
- ステータス管理（判定〜就業決定／辞退／見送り）
- 候補者一覧・検索・閲覧ステータス
- マスタ管理（希望職種・派遣元・ステータス）
- 職場見学リマインド通知（メール）

### 2.2 除外範囲
- 就業開始後の契約・勤怠管理・請求処理
- 派遣元との外部ポータル連携
- 労務関連帳票の出力

---

## 3. 利用者・権限

| ロール | 対象者 | 主な権限 |
|---|---|---|
| 管理者 (`manager`) | 受入責任者、管理部門 | 全機能利用、マスタ管理、監査ログ参照 |
| 受入担当 (`staff`) | 各部署の受入担当者 | 候補者登録・編集・一覧・ステータス更新、見学確定、通知確認 |

- ログイン: メールアドレス + パスワード（Laravel Breeze/Fortify ベース）。
- MFA / IP 制限は任意機能として今後追加余地あり（現時点では未実装）。

---

## 4. システム全体構成

### 4.1 論理構成図（テキスト）
```
ユーザー(社内PC) → IIS + PHP (Laravelアプリ) → MySQL DB
                                     ↘ Redis (Queue)
                                     ↘ SMTP (社内メール)
                                     ↘ LINE WORKS Calendar API (外部)
```

### 4.2 モジュール構成
- **アプリ層**: `app/Http`, `app/Services`, `app/Jobs`, `app/Mail`
- **バッチ層**: Laravel Scheduler (`app/Console/Kernel`) + ジョブ (`SendInterviewReminderJob`)
- **連携層**: `LineworksCalendarService`（LINE WORKS カレンダー連携）
- **データ層**: MySQL テーブル群（`candidates`, `interviews`, `candidate_views`, `notifications`, ほか）

---

## 5. 外部連携

### 5.1 LINE WORKS カレンダー連携
- 目的: 職場見学確定時に LINE WORKS の社内カレンダーへイベント登録。
- 利用 API: LINE WORKS Calendar API（サービスアカウント）。
- 主な処理:
  1. `createInterviewEvent` で面談件名や説明を生成。
  2. `createEvent` で API 呼び出し。
  3. 登録成功時にイベント ID を保持（将来の同期用）。
- エラーハンドリング: `LineworksServiceUnavailableException` をスローし UI に通知。
- **最新更新点**: API から "Start time not set" エラーが返却された場合、自動的に日時にタイムゾーンオフセット（例: `+09:00`）を付与して再送するフォールバックを実装（2025-09 リリース）。ログに警告出力し、再試行はリトライ設定（既定3回、250ms間隔）。

### 5.2 メール(SMTP)
- 社内 SMTP サーバを利用し、通知メールを送信。
- `InterviewReminderMail` でテンプレートレンダリング。
- 通知履歴は `notifications` テーブルに記録。

### 5.3 Access 連携
- MySQL を Access から ODBC リンクし、一覧参照を可能にする想定。
- `INT` 型・`VARCHAR` 型中心のスキーマを採用し互換性を確保。

---

## 6. 業務フロー（概要）
1. 派遣会社から候補者情報（メール + PDF）を受領。
2. 受入担当がシステムで候補者登録（PDF添付、見学候補日入力）。
3. 候補者一覧で状況確認、担当者アサイン、未閲覧の識別。
4. 見学調整が完了したら確定日時を登録 → LINE WORKS 連携 → リマインド設定。
5. 見学実施後にステータス更新（判定中→結果）。就業決定時は開始日を必須登録。
6. リマインドジョブが所定のタイミングでメール送信。
7. 案件終了後はステータス履歴・ログを保持、将来用に閲覧可能。

---

## 7. 画面／機能概要

| 画面 | 概要 | 主な機能 |
|---|---|---|
| トップメニュー | ログイン後の初期画面 | 紹介者登録／一覧／マスタ管理への遷移、権限に応じた表示制御 |
| 紹介者登録・編集 | 候補者情報入力フォーム | 基本情報、希望職種、見学候補日、対応者、条件、PDF 添付、バリデーション |
| 紹介者一覧 | 候補者の検索・一覧表示 | フィルタ（未閲覧、職種、派遣元等）、並び替え、色バッジ、行アクション（詳細・編集・見学確定）|
| 紹介者詳細 | 詳細情報の閲覧 | ステータス更新、閲覧ログ記録 |
| マスタ管理 | 希望職種／ステータス／派遣元の管理 | CSV インポート/エクスポート、使用可否切り替え |
| 通知履歴（将来案） | 通知ログ確認 | 失敗再送、ダイジェスト生成（バックログ） |

---

## 8. データ構成

### 8.1 主要テーブル
- `users`: 社内ユーザー。`role = manager|staff`、`is_active`、`last_login_at`。
- `candidates`: 候補者基本情報・希望職種・見学候補日・ステータス・就業開始日。
- `interviews`: 見学確定情報とリマインドフラグ（`remind_prev_day_sent`, `remind_1h_sent`, `remind_30m_sent`, `remind_30m_enabled`）。
- `candidate_status_histories`: ステータス変更履歴と理由。
- `candidate_views`: ユーザー別閲覧履歴（未閲覧判定用）。
- `skill_sheets`: PDF ファイル情報。
- `job_categories`, `candidate_statuses`, `agencies`: マスタ。
- `notifications`: 通知履歴と送信結果。

### 8.2 データ連携上の注意
- `other_conditions` は JSON 文字列を TEXT 保存（Access 互換）。
- トランザクション: 候補者登録時に候補者 + スキルシート + ステータス履歴を一括登録。

---

## 9. バッチ・スケジュール

| 種別 | 内容 | 間隔 | 備考 |
|---|---|---|---|
| Scheduler | `SendInterviewReminderJob` ディスパッチ | 5分毎 | Windows タスクスケジューラで `php artisan schedule:run` を1分毎実行 |
| Queue Worker | `queue:work --queue=reminders,default` | 常駐 | サービス化（自動再起動） |
| バックアップ | DB フルバックアップ | 日次 | 30日保持。アプリログ/WORM保管計画あり |

- リマインドジョブは対象時間帯と `remind_*_sent` フラグを確認し、重複送信を防止。
- 送信失敗時は `notifications.status = failed` として記録、再送は手動（将来実装）。

---

## 10. 非機能要件

| 項目 | 目標値 / 方針 |
|---|---|
| パフォーマンス | 同時ログイン200ユーザー、P95レスポンス < 2秒 |
| 可用性 | 稼働率 99.5%（平日8-20時） |
| 監視 | AP/DB/Queue 監視、エラートラッキング、死活監視。通知失敗はログ + 管理者ダイジェスト（将来） |
| バックアップ | DB フル日次 + 増分、30日保持、半期でリストア訓練 |
| ログ保全 | 監査ログは WORM 方針で保持、削除不可 |

---

## 11. セキュリティ

- 認証: メール + パスワード。パスワード再発行機能は未実装（将来対応予定）。
- パスワードポリシー: 英数混在 8 文字以上（Fortify 標準を基準に設定）。
- アカウントロック: 失敗 5 回で 10 分ロック。
- 通信: 社内ネットワーク内利用前提。外部公開時は HTTPS 必須。
- データ暗号化: 交通費等の個人情報・口座情報は DB 側暗号化（Laravel 暗号化ヘルパーを利用予定）。
- 脆弱性対策: OWASP ASVS L1 準拠を目標に、CSRF/XSS/SQLi 対策は Laravel 標準機能を活用。
- 監査ログ: `spatie/laravel-activitylog` の導入を想定し、主要操作を記録。

---

## 12. ファイル管理

- 保存先: `storage/app/private/skill_sheets/{candidate_id}/`。
- アクセス: 認可済みユーザーのみダウンロード、`storage:link` は使用しない。
- 容量制限: 1 ファイル 10MB（PDF のみ）。複数ファイルに対応（初期設定は最大5件）。
- ウイルススキャン: 現時点で未実装。情シスと調整のうえ、運用マニュアルで暫定対応。

---

## 13. 監査・運用

- 操作ログ: ログイン、候補者 CRUD、ステータス更新、見学確定、マスタ変更、閲覧ログの「未読に戻す」を記録。
- アクセスログ: IIS 標準ログを収集し、既存 SIEM 連携を検討。
- 運用手順: バックアップ復元リハーサル、通知失敗時の手動再送手順を整備予定。

---

## 14. 変更履歴

| 日付 | 版 | 変更内容 | 担当 |
|---|---|---|---|
| 2025-09-29 | 0.1 | 初版（要件定義・設計メモを統合しシステム定義書ドラフト化） | プロジェクトチーム |
| 2025-09-29 | 0.1 | LINE WORKS "Start time not set" フォールバック仕様を追記 | 同上 |
| 2025-10-15 | 0.1 | パスワード再発行機能の実装状況を未実装と明記 | プロジェクトチーム |

---

> 本資料はドラフト版です。レビュー結果を反映し、承認後に正式版として管理します。
