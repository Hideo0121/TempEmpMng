# 通知・リマインド設計メモ（ドラフト）

作成日: 2025-09-25  
対象: 短期派遣受入管理システム  
目的: 職場見学リマインド通知の処理設計・スケジューラ構成・運用ルールを明文化する。

---

## 1. 通知概要
- 対象イベント: `interviews` テーブルの `scheduled_at`。
- 通知タイミング: 前日9:00 / 1時間前 / 30分前（候補ごとに ON/OFF）。
- 通知先: 職場見学対応者（1〜2名・必須）、登録ユーザー（受入担当）、管理者CC（既定ON）。
- 手段: 社内SMTP経由のメール送信。
- 目的: リマインド送信の自動化と重複防止、失敗時の可視化。

## 2. コンポーネント構成
| レイヤ | コンポーネント | 役割 |
|---|---|---|
| バッチ | Laravel Scheduler (`app\Console\Kernel`) | 5分間隔で Reminder スキャンジョブを起動。 |
| ジョブ | `SendInterviewReminder` (queue: reminders) | 対象リマインドタイミングを判定し、メール生成・送信をキューに分離。 |
| メール | `InterviewReminderMail` | Blade テンプレート(`emails.interview_reminder`)を利用し、通知本文を生成。 |
| データ | `notifications` テーブル | 送信履歴・ステータス (`pending`/`sent`/`failed`) を記録。 |
| ロギング | `notifications` + `laravel.log` | 送信成否と例外ログを統合。 |

## 3. 処理フロー
1. Scheduler が5分間隔で `dispatch(new SendInterviewReminderJob)` を実行。
2. ジョブは以下を実施:
   - 現在時刻を基準に「前日9:00」「1時間前」「30分前」のウィンドウに該当する `interviews` を検索。
   - 既に該当タイミングで送信済み (`remind_*_sent = true`) のレコードを除外。
   - `notifications` にキューイングレコードを作成（`status = pending`）。
   - `InterviewReminderMail` を生成し、`Mail::queue()` で送信。
   - 送信成功時は `notifications.sent_at`・`status = sent`・`interviews.remind_*_sent = true` を更新。
   - 失敗時は `status = failed` と `error_message` を保存、`Log::error` を出力。失敗通知はダイジェストで管理者向けに別途（将来対応）。

## 4. スケジューラ設定
- Windows Server ではタスクスケジューラで 1分毎に `php artisan schedule:run` を実行。
- Cron 表記: `* * * * *` (サーバ側)。
- Laravel 側: `app\Console\Kernel::schedule` にて `dispatch` を5分刻みで設定。
- Queue Worker: `php artisan queue:work --queue=reminders,default --sleep=3` をサービス化。

## 5. メールテンプレート仕様
- Blade: `resources/views/emails/interview_reminder.blade.php`。
- 件名: `[職場見学リマインド] {{ candidate_name }} さん {{ scheduled_at->format('Y/m/d H:i') }}`。
- 本文要素:
  - 候補者名、派遣会社、確定日時、場所。
  - 対応者一覧と役割。
  - 30分前リマインドがOFFの場合、その旨を脚注に記載。
  - 送信対象に応じた挨拶（対応者向け / CC 管理者向けには一律案内）。
- 署名: 受入管理チーム（固定文言）。

## 6. 環境変数・設定
| 変数 | 用途 | 例 |
|---|---|---|
| `MAIL_MAILER` | SMTP | `smtp` |
| `MAIL_HOST` `MAIL_PORT` `MAIL_USERNAME` `MAIL_PASSWORD` | SMTP 接続設定 | 社内SMTP情報 |
| `REMINDER_TIMEZONE` | 送信タイムゾーン | `Asia/Tokyo` |
| `REMINDER_DISABLE_30M` | 30分前リマインド全体無効（緊急停止用） | `false` |
| `REMINDER_CC_MANAGERS` | 管理者CCのメールアドレスCSV | `manager1@example.com,manager2@example.com` |

## 7. 失敗・リトライ方針
- キュー失敗時: Laravel のキューワーカーが自動リトライ（3回、指数バックオフ 60s/300s/900s）。
- 全失敗後: `failed_jobs` テーブルに蓄積、1時間毎に管理者へダイジェストメール（将来機能、バックログ登録）。
- 手動再送: `notifications` 一覧（将来メニュー）で `failed` を再送キューに積むボタンを想定。

## 8. テーブル更新仕様
- `interviews`:
  - `remind_prev_day_sent` / `remind_1h_sent` / `remind_30m_sent` を bool で保持。
  - `remind_30m_enabled` が false の場合は 30分前タイミングをスキップ。
- `notifications`:
  - レコード1件に対し、1タイミング1通が基本。複数宛先は JSON 化された `to_addresses` / `cc_addresses`。
  - `status` 状態遷移: `pending` → (`sent` | `failed`)。

## 9. モジュール実装タスク（開発ToDo）
- [x] リポジトリ/サービス: Interview のリマインド対象を抽出するクエリービルダ（`App\\Services\\InterviewReminderService`）。
- [x] Job 実装: `SendInterviewReminderJob` にロジック実装、`notifications` 更新。
- [x] Mailable: `InterviewReminderMail` にテンプレートデータをバインド。
- [x] ビュー: `emails.interview_reminder` の整備。
- [x] スケジューラ: `app\Console\Kernel` で dispatch 設定。
- [x] テスト: フェイク Mail / Queue を使用したユニットテストと時間経過シナリオの Feature テスト。

---

> 本メモはドラフトです。レビューの結果を反映して更新します。
